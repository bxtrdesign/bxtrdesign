<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>bxtr.design</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<script>
const baseWidth = 1920;
const baseCellSize = 16;
const minCellSize = 8;
let highlightRadius = 300;
let highlightFalloff = 0.7;

let asciiVideo; // desktop video
let asciiImage; // mobile static image
let videoReady = false;

let asciiPalette = " bxtrBXTR.,'*+;:>";
let isMobile = /Mobi|Android/i.test(navigator.userAgent);

let cols, rows;
let scaledWidth, scaledHeight;
let offsetX, offsetY;
let aspectRatio;

function preload() {
  if (!isMobile) {
    asciiVideo = createVideo("bxtr.mp4");
    asciiVideo.hide();
    asciiVideo.volume(0);
  } else {
    asciiImage = loadImage("bxtrstatic.png");
  }
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  textFont("monospace");
  textAlign(LEFT, TOP);
  fill(255);

  if (!isMobile) {
    asciiVideo.elt.onloadedmetadata = () => {
      asciiVideo.loop();
      asciiVideo.play();
      videoReady = true;
      aspectRatio = asciiVideo.width / asciiVideo.height;
      updateScaling();
    };
  } else {
    // Mobile: calculate scale when image loaded
    asciiImage.loadPixels();
    aspectRatio = asciiImage.width / asciiImage.height;
    updateScaling();
    videoReady = true;
  }
}

function updateScaling() {
  const canvasAspect = width / height;
  if(canvasAspect > aspectRatio){
    scaledHeight = height;
    scaledWidth = height * aspectRatio;
  } else {
    scaledWidth = width;
    scaledHeight = width / aspectRatio;
  }
  offsetX = (width - scaledWidth) / 2;
  offsetY = (height - scaledHeight) / 2;

  let scaledCellSize = baseCellSize * (width / baseWidth);
  scaledCellSize = max(scaledCellSize, minCellSize);

  cols = floor(scaledWidth / scaledCellSize);
  rows = floor(scaledHeight / scaledCellSize);
}

function draw() {
  if (!videoReady) return;
  background(0);

  loadPixels();
  let img;
  if (isMobile) img = asciiImage;
  else img = asciiVideo;

  img.loadPixels();

  let cellWidth = scaledWidth / cols;
  let cellHeight = scaledHeight / rows;

  let mouseXPos = isMobile && touches.length > 0 ? touches[0].x : mouseX;
  let mouseYPos = isMobile && touches.length > 0 ? touches[0].y : mouseY;

  for (let y=0; y<rows; y++){
    for (let x=0; x<cols; x++){
      let px = floor((x/cols) * img.width);
      let py = floor((y/rows) * img.height);
      let idx = (py*img.width + px) * 4;
      let r = img.pixels[idx];
      let g = img.pixels[idx+1];
      let b = img.pixels[idx+2];
      let brightness = (r+g+b)/3/255;
      let charIdx = floor((1-brightness)*(asciiPalette.length-1));
      let c = asciiPalette[charIdx];

      // Highlight factor
      let cellCenterX = offsetX + x*cellWidth + cellWidth/2;
      let cellCenterY = offsetY + y*cellHeight + cellHeight/2;
      let dist = dist2D(cellCenterX, cellCenterY, mouseXPos, mouseYPos);
      let highlight = constrain(1 - dist/highlightRadius, 0, 1);
      highlight = pow(highlight, highlightFalloff);

      fill(lerpColor(color(r,g,b), color(255,255,255), highlight));
      text(c, offsetX + x*cellWidth, offsetY + y*cellHeight);
    }
  }
}

function dist2D(x1, y1, x2, y2){
  return sqrt((x2-x1)*(x2-x1) + (y2-y1)*(y2-y1));
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  if(videoReady) updateScaling();
}
</script>
</body>
</html>
